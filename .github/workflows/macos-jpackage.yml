name: Build macOS installer (DMG)

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-dmg:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Build with Maven
        run: mvn -DskipTests clean package

      - name: Generate PNG icon (IconGenerator)
        run: |
          java -cp target/xslt-transformer-app-1.0.0.jar IconGenerator target/app-icon.png

      - name: Create iconset and convert to .icns
        run: |
          rm -rf target/icon.iconset || true
          mkdir -p target/icon.iconset
          sips -z 16 16 target/app-icon.png --out target/icon.iconset/icon_16x16.png
          sips -z 32 32 target/app-icon.png --out target/icon.iconset/icon_16x16@2x.png
          sips -z 32 32 target/app-icon.png --out target/icon.iconset/icon_32x32.png
          sips -z 64 64 target/app-icon.png --out target/icon.iconset/icon_32x32@2x.png
          sips -z 128 128 target/app-icon.png --out target/icon.iconset/icon_128x128.png
          sips -z 256 256 target/app-icon.png --out target/icon.iconset/icon_128x128@2x.png
          sips -z 256 256 target/app-icon.png --out target/icon.iconset/icon_256x256.png
          sips -z 512 512 target/app-icon.png --out target/icon.iconset/icon_256x256@2x.png
          sips -z 512 512 target/app-icon.png --out target/icon.iconset/icon_512x512.png
          sips -z 1024 1024 target/app-icon.png --out target/icon.iconset/icon_512x512@2x.png
          iconutil -c icns target/icon.iconset -o target/app-icon.icns

      - name: Create DMG with jpackage
        run: |
          jpackage --type dmg \
            --input target \
            --name XsltTransformer \
            --main-jar xslt-transformer-app-1.0.0.jar \
            --main-class XsltTransformerApp \
            --icon target/app-icon.icns \
            --app-version 1.0.0 \
            --dest target/installer

      - name: Zip app image
        if: github.event_name == 'release'
        run: |
          if [ -d "target/installer/XsltTransformer.app" ]; then
            ditto -c -k --sequesterRsrc --keepParent target/installer/XsltTransformer.app target/installer/XsltTransformer.app.zip
          fi

      - name: Upload DMG to GitHub Release
        if: github.event_name == 'release'
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: target/installer/XsltTransformer-1.0.0.dmg
          asset_name: XsltTransformer-${{ github.event.release.tag_name }}.dmg
          asset_content_type: application/x-apple-diskimage

      - name: Upload App ZIP to GitHub Release
        if: github.event_name == 'release'
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: target/installer/XsltTransformer.app.zip
          asset_name: XsltTransformer-${{ github.event.release.tag_name }}.app.zip
          asset_content_type: application/zip
