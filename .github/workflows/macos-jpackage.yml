name: Build macOS installer (DMG)

on:
  release:
    types: [published]
  workflow_dispatch:

permissions: write-all

jobs:
  build-dmg:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Build with Maven
        run: mvn -DskipTests clean package

      - name: Generate PNG icon (IconGenerator)
        run: |
          java -cp target/xslt-transformer-app-1.0.0.jar IconGenerator target/app-icon.png

      - name: Create iconset and convert to .icns
        run: |
          rm -rf target/icon.iconset || true
          mkdir -p target/icon.iconset
          sips -z 16 16 target/app-icon.png --out target/icon.iconset/icon_16x16.png
          sips -z 32 32 target/app-icon.png --out target/icon.iconset/icon_16x16@2x.png
          sips -z 32 32 target/app-icon.png --out target/icon.iconset/icon_32x32.png
          sips -z 64 64 target/app-icon.png --out target/icon.iconset/icon_32x32@2x.png
          sips -z 128 128 target/app-icon.png --out target/icon.iconset/icon_128x128.png
          sips -z 256 256 target/app-icon.png --out target/icon.iconset/icon_128x128@2x.png
          sips -z 256 256 target/app-icon.png --out target/icon.iconset/icon_256x256.png
          sips -z 512 512 target/app-icon.png --out target/icon.iconset/icon_256x256@2x.png
          sips -z 512 512 target/app-icon.png --out target/icon.iconset/icon_512x512.png
          sips -z 1024 1024 target/app-icon.png --out target/icon.iconset/icon_512x512@2x.png
          iconutil -c icns target/icon.iconset -o target/app-icon.icns

      - name: Create DMG with jpackage
        run: |
          jpackage --type dmg \
            --input target \
            --name XsltTransformer \
            --main-jar xslt-transformer-app-1.0.0.jar \
            --main-class XsltTransformerApp \
            --icon target/app-icon.icns \
            --app-version 1.0.0 \
            --dest target/installer

      - id: find_app_zip
        name: Find or create App ZIP
        if: github.event_name == 'release'
        run: |
          set -e
          APP_DIR=""
          # Prefer the expected path
          if [ -d "target/installer/XsltTransformer.app" ]; then
            APP_DIR="target/installer/XsltTransformer.app"
          else
            # Try to find any .app produced by jpackage
            FOUND=$(find target/installer -maxdepth 2 -name "*.app" -print -quit || true)
            if [ -n "$FOUND" ]; then
              APP_DIR="$FOUND"
            fi
          fi

          if [ -n "$APP_DIR" ]; then
            BASENAME=$(basename "$APP_DIR")
            ZIP_PATH="target/installer/${BASENAME}.zip"
            echo "Found app: $APP_DIR -> will create $ZIP_PATH"
            ditto -c -k --sequesterRsrc --keepParent "$APP_DIR" "$ZIP_PATH"
            echo "asset_path=$ZIP_PATH" >> "$GITHUB_OUTPUT"
          else
            echo "No .app found in target/installer; skipping app zip creation"
            echo "asset_path=" >> "$GITHUB_OUTPUT"
            ls -la target/installer || true
          fi

      - name: Upload DMG to GitHub Release
        if: github.event_name == 'release'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: target/installer/XsltTransformer-1.0.0.dmg
          asset_name: XsltTransformer-${{ github.event.release.tag_name }}.dmg
          asset_content_type: application/x-apple-diskimage

      - name: Upload App ZIP to GitHub Release
        if: github.event_name == 'release' && steps.find_app_zip.outputs.asset_path != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ${{ steps.find_app_zip.outputs.asset_path }}
          asset_name: XsltTransformer-${{ github.event.release.tag_name }}.app.zip
          asset_content_type: application/zip
