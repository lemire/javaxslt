name: Build Windows installer (MSI)

on:
  release:
    types: [published]
  workflow_dispatch:

permissions: write-all

jobs:
  build-msi:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Build with Maven
        run: mvn -DskipTests clean package

      - name: Generate PNG icon (IconGenerator)
        run: |
          java -cp target/xslt-transformer-app-1.0.0.jar IconGenerator target/app-icon.png

      - name: Install ImageMagick (for .ico conversion)
        run: choco install imagemagick -y

      - name: Convert PNG to ICO
        run: magick convert target/app-icon.png -define icon:auto-resize=256,128,64,48,32,16 target/app-icon.ico

      - name: Ensure WiX is installed
        run: choco install wixtoolset -y

      - name: Create MSI with jpackage
        run: |
          jpackage --type msi \
            --input target \
            --name XsltTransformer \
            --main-jar xslt-transformer-app-1.0.0.jar \
            --main-class XsltTransformerApp \
            --icon target/app-icon.ico \
            --app-version 1.0.0 \
            --dest target/installer

      - name: Upload MSI to GitHub Release
        if: github.event_name == 'release'
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: target/installer/XsltTransformer-1.0.0.msi
          asset_name: XsltTransformer-${{ github.event.release.tag_name }}.msi
          asset_content_type: application/x-msi
